<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Variation â€“ Enhanced Creative</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--border:#e5e7eb;--muted:#6b7280;}
    *{box-sizing:border-box}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;margin:0;padding:20px;color:#111827;background:#fff}
    h1,h2,h3{margin:0 0 12px}
    .error{color:#b00020;background:#ffecec;padding:10px;border-radius:8px;margin-bottom:16px}
    .wrap{display:grid;grid-template-columns:1fr;gap:24px}
    .card{border:1px solid var(--border);border-radius:12px;padding:16px;background:#fff}
    .imgbox img{max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    textarea,input[type="text"],input[type="url"],input[type="number"],select{
      width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;background:#fff
    }
    input[type="file"]{margin:6px 0 12px}
    button{padding:9px 12px;border:none;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
    button:hover{opacity:.9}
    .muted{color:var(--muted)}
    .meta small{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 900px){.row{grid-template-columns:1fr}}
    pre{white-space:pre-wrap;word-break:break-word;background:#f9fafb;padding:12px;border-radius:8px;border:1px solid var(--border)}
    .toolbtn{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}
    .toolbtn.active{background:#111827;color:#fff}
    .toolbar-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .toolline{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .sidebar{min-width:260px;max-width:320px;border:1px solid var(--border);border-radius:10px;padding:12px}
    .canvas-shell{border:1px solid var(--border);border-radius:10px;padding:10px}
    .canvas-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .zoom-btn{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}
    .zoom-label{display:inline-block;width:56px;text-align:center}
    .tiny-note{font-size:12px;color:var(--muted)}
    .inline{display:flex;gap:8px;align-items:center}
    .hr{border-top:1px solid var(--border);margin:10px 0}
  </style>
   <style>
.right-note{
  position: fixed;
  top: 30px;          /* closer to the top */
  right: 48px;        /* not hugging the edge anymore */
  width: 420px;       /* larger card */
  max-width: 38vw;    /* keep sane on ultra-wide screens */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:16px 18px;
  box-shadow:0 8px 28px rgba(0,0,0,.08);
  z-index:50;
}
.right-note h3{margin:0 0 8px;font-size:16px;font-weight:700;color:#111827}
.right-note p{margin:6px 0;font-size:14.5px;color:#374151;line-height:1.4;white-space:pre-line}
.right-note .muted{color:#6b7280;font-size:12px;margin-top:6px}

/* hide on smaller viewports so it doesnâ€™t overlap */
@media (max-width: 1280px){
  .right-note{display:none}
}
</style>
</head>
<body>
  <h1>Generate Variation</h1>

  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}

  <div class="wrap">
    <!-- Current Output -->
    <div class="card">
      <h2>Current Output</h2>
      {% if output_image_name %}
        <div class="imgbox">
          <img src="{{ url_for('outputs', filename=output_image_name) }}" alt="Current Enhanced Creative" />
        </div>
        <p style="margin:10px 0 0;">
          <a href="{{ url_for('outputs', filename=output_image_name) }}" download="{{ output_image_name }}">ðŸ“¥ Download This Image</a>
        </p>
      {% else %}
        <p class="meta"><small>No output yet in this session. Generate one first.</small></p>
      {% endif %}
      <p class="meta" style="margin-top:8px;">
        <small><strong>Base Image:</strong> {{ base_image_name or 'â€”' }}</small><br/>
        <small><strong>Landing URL:</strong> {{ landing_url or 'â€”' }}</small>
      </p>
    </div>
     <div class="right-note" aria-label="AI limitations note">
  <h3>Note</h3>
  <p>
LLM,AI have more limitataion
  and restriction than 
living human being

To Be smarter read my limitation
   rather than usecase and dependent
  </p>
  <div class="muted">Hard-coded UI note (not part of the creative image)</div>
</div>

    {% if output_image_name %}
    <!-- Manual Editor (Fallback Toolbox) -->
    <div class="card">
      <h2>Manual Edit (Fallback Toolbox)</h2>
      <p class="tiny-note">
        If the model canâ€™t fix small spellings/layout, use this quick editor. Paint, erase, add text, or draw a selection to restrict edits, then save as a new variation (or promote it to the base).
      </p>

      <div id="editor-wrap" style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
        <!-- Toolbox -->
        <div class="sidebar">
          <!-- Tools -->
          <div class="toolbar-grid">
            <button id="tool-brush" class="toolbtn" type="button">Brush</button>
            <button id="tool-erase" class="toolbtn" type="button">Eraser</button>
            <button id="tool-text"  class="toolbtn" type="button">Text</button>
            <button id="tool-move"  class="toolbtn" type="button">Pan</button>
            <button id="selectBtn"  class="toolbtn" type="button">Select</button>
            <button id="clearSelBtn" class="toolbtn" type="button">Clear Sel</button>
            <button id="pick" type="button">Pick</button>


          </div>

          <!-- Brush/Eraser color/size -->
          <div class="row" style="margin-bottom:6px;">
            <label>Color
              <input id="color" type="color" value="#ffffff" />
            </label>
            <label>Size
              <input id="size" type="range" min="2" max="60" value="22" />
            </label>
          </div>

          <!-- Text Controls -->
          <div id="text-controls" style="margin-top:10px;border-top:1px solid #eee;padding-top:10px;">
            <div style="font-weight:600;margin-bottom:6px;">Text Style</div>

            <label>Font
              <select id="fontFamily">
                <option value="system-ui, -apple-system, Segoe UI, Roboto, Arial">System</option>
                <option value="Inter, system-ui, Segoe UI, Roboto, Arial">Inter</option>
                <option value="Arial, Helvetica, sans-serif">Arial</option>
                <option value="Helvetica, Arial, sans-serif">Helvetica</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
              </select>
            </label>

            <div class="row" style="margin-bottom:8px;">
              <label>Size
                <input id="fontSize" type="number" min="8" max="180" value="28" />
              </label>
              <label>Color
                <input id="textColor" type="color" value="#111111" />
              </label>
            </div>

            <div class="inline">
              <label class="inline"><input type="checkbox" id="fontBold"> Bold</label>
              <label class="inline"><input type="checkbox" id="fontItalic"> Italic</label>
            </div>

            <p class="tiny-note" style="margin-top:8px;">
              Tip: Click the canvas with <em>Text</em> tool to drop a text box. Drag edges/corners to resize. Double-click to edit text.
            </p>
          </div>

          <div class="hr"></div>

          <!-- Selection restriction -->
          <label class="inline" style="margin:8px 0;">
            <input type="checkbox" id="restrictSel" checked />
            Restrict edits to selection
          </label>

          <!-- Undo/Redo/Clear -->
          <div class="toolline">
            <button id="undo" class="toolbtn" type="button">Undo</button>
            <button id="redo" class="toolbtn" type="button">Redo</button>
            <button id="clear" class="toolbtn" type="button">Clear</button>
          </div>

          <!-- Download -->
          <div class="toolline">
            <button id="download" class="toolbtn" type="button">Download PNG</button>
          </div>

          <!-- Save -->
          <form id="save-form" method="post" action="/edit/save" class="inline" style="flex-wrap:wrap;gap:10px;">
            <input type="hidden" name="img" id="save-img-field">
            <label class="inline" style="gap:6px;">
              <input type="checkbox" name="set_as_base" id="set-as-base"> Set as new base
            </label>
            <button id="save" type="submit">Save to Pipeline</button>
          </form>
          <p id="save-status" class="tiny-note"></p>
        </div>

        <!-- Canvas -->
        <div class="canvas-shell" style="max-width:calc(min(90vw,520px));">
          <div class="canvas-head">
            <strong>Canvas</strong>
            <div class="inline">
              <button id="zoom-out" class="zoom-btn" type="button">âˆ’</button>
              <span id="zoom-label" class="zoom-label">100%</span>
              <button id="zoom-in" class="zoom-btn" type="button">+</button>
            </div>
          </div>
          <div style="overflow:auto;max-height:80vh;">
            <canvas id="edit-canvas" width="360" height="640" style="display:block;background:#111;border-radius:6px;"></canvas>
          </div>
        </div>
      </div>

      <!-- Pass current output URL to the editor script -->
      <script>
        window.__CURRENT_OUTPUT_URL = "{{ url_for('outputs', filename=output_image_name) }}";
        //window.__CURRENT_OUTPUT_URL = "https://d1rjs2m4wfq83w.cloudfront.net/dpi/creatives/dabur_honey_20251024034925_creative_1.png";
         
        //window.__CURRENT_OUTPUT_URL ="/proxy_image?url={{ 'https://d1rjs2m4wfq83w.cloudfront.net/dpi/creatives/dabur_honey_20251024034925_creative_1.png' | urlencode }}";
      </script>
      <script src="{{ url_for('static', filename='editor.js') }}"></script>
    </div>
    {% endif %}

    <!-- Variation Controls -->
    <div class="card">
      <h2>Variation Controls</h2>
      <form action="/variation" method="post" enctype="multipart/form-data">
        <label for="image2">Upload New Base Image (optional, PNG only)</label>
        <input type="file" id="image2" name="image2" accept=".png" />

        <label class="inline" style="gap:.5rem;margin:8px 0 16px;">
          <input type="checkbox" name="allow_text_changes" value="1" {{ allow_text_changes }}>
          Allow text changes (spelling/rewrites)
        </label>

        <label for="manual_override">Manual Override (optional)</label>
        <textarea id="manual_override" name="manual_override" rows="2" placeholder='e.g. Change color palette,lighting,layout'></textarea>

        <label for="feedback">Feedback on Previous Output (optional)</label>
        <textarea id="feedback" name="feedback" rows="3" placeholder='e.g. Typo, Spell checks,'></textarea>


          <div class="row">
           <div>
            <label for="aspect_ratio">Aspect Ratio</label>
            <select id="aspect_ratio" name="aspect_ratio">
              {% set ar = (aspect_ratio or '9:16') %}
              {% for opt in ['1:1','4:5','9:16','16:9','3:4','4:3','2:3','3:2'] %}
                <option value="{{ opt }}" {% if opt==ar %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="temperature">Temperature</label>
            <select id="temperature" name="temperature">
              {% set tempv = (temperature or 0.6) %}
              {% for t in ['0.0','0.1','0.2','0.3','0.4','0.5','0.6','0.7','0.8','0.9','1.0'] %}
                <option value="{{ t }}" {% if (t|float) == (tempv|float) %}selected{% endif %}>{{ t }}</option>
              {% endfor %}
            </select>
            <div class="hint" style="margin-top:6px">Lower = safer/precise, Higher = more creative.</div>
          </div>
        </div>

        <label for="brand_url">Landing URL (optional, retained if empty)</label>
        <input id="brand_url" name="brand_url" type="url" value="{{ landing_url or '' }}" placeholder="https://example.com" />

        <div style="margin-top:12px;">
          <button type="submit">Generate Variation</button>
        </div>
        <p class="tiny-note" style="margin-top:6px;">
          If you leave all fields empty and donâ€™t upload a file, a new variant is generated using the last output as base.
        </p>
      </form>
    </div>

    {% if tokens or prompt_full %}
    <div class="card">
      <h2>Debug / Prompt Info</h2>
      {% if tokens %}
        <p class="meta"><small><strong>Tokens:</strong> total {{ tokens.total or 0 }}, in {{ tokens.input or 0 }}, out {{ tokens.output or 0 }}</small></p>
      {% endif %}
      {% if prompt_full %}
        <h3>Last Prompt</h3>
        <pre>{{ prompt_full }}</pre>
      {% endif %}
      {% if model_text or model_image %}
        <p class="meta"><small><strong>Models:</strong> {{ model_text }} / {{ model_image }}</small></p>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <p style="margin-top:20px;">
    <a href="/">âŸµ Back to Home</a>
  </p>
</body>
</html>
